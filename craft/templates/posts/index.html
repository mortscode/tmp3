{% extends "_layout" %}

{% set recipe = entry.recipeBuilder|length or entry.recipeMethod|length %}
{% set articleType = recipe ? 'Recipe' : 'Article' %}

{% set photoArray = [entry.featuredImage[0].url('facebookSeo'), entry.featuredImage[0].url] %}
{% set ingredientsArray = [] %}

{% for block in entry.postBuilder.with(['photos:imageFiles']) %}
  {% if block.type.handle == 'photos' %}
    {% for photo in block.imageFiles %}
      {% if photo.height > photo.width %}
        {% set photoArray = photoArray|merge([photo.url]) %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

{% set seomaticMeta = seomaticMeta | merge({
    og: {
        image: photoArray[0:6],
    }
}) %}

{% if seomaticMainEntityOfPage is defined %}
    {% set seomaticMainEntityOfPage = seomaticMainEntityOfPage | merge({'image': photoArray[1:7] }) %}
{% endif %}

{% block content %}
{% if entry.recipeBuilder|length %}
  <div class="-off-screen" aria-hidden="true" itemscope itemtype="http://schema.org/Recipe">
    <meta class="-off-screen" itemprop="url" content="{{ entry.url }}" />
    <span class="-off-screen" itemprop="name">{{ entry.postEntrySeo.seoTitle is defined ? entry.postEntrySeo.seoTitle : entry.title }}</span>
    <span class="-off-screen" itemprop="recipeYield">{{ entry.recipeServings > 0 ? "Serves " ~ entry.recipeServings : "" }}</span>
    {% for block in entry.recipeBuilder %}
      {% if loop|length > 1 and block.listTitle|length == 0 or loop.first %}
        {% for ingredient in block.list %}
          {% set fullIngredient = ingredient.amount ? ingredient.amount ~ " " ~ ingredient.ingredient : ingredient.ingredient %}
          {% set ingredientsArray = ingredientsArray|merge([fullIngredient]) %}
          <span class="-off-screen" itemprop="ingredients">{{ fullIngredient }}</span>
        {% endfor %}
      {% endif %}
    {% endfor %}
  </div>
{% endif %}
  <div class="post-entry">
    <div class="post-intro">
      <div class="post-intro__title">
        <time class="post-intro__title--date">{{entry.postDate.format('F d, Y')}}</time>
        <h1 class="post-intro__title--text">{{entry.title}}</h1>
        {% if entry.postAuthor|length %}
          <span class="post-intro__title--author author">Story by {{entry.postAuthor}}</span>
        {% endif %}
        {% include 'posts/_share' %}
        {% if recipe %}
          {% spaceless %}
          <button class="post-intro__title--button js-scroll-to" data-scroll-target='recipe'>
            <div class="post-intro__title--button-text">Jump to recipe</div>
            {% include 'utils/icon' with {'icon':'chevron-down', 'classes':'post-intro__title--chevron'} %}
          </button>
          {% endspaceless %}
        {% endif %}
      </div>
      <div class="post-intro__image">
        {% set imageAlt = entry.featuredImage[0].imageAlt ? entry.featuredImage[0].imageAlt : entry.postEntrySeo.seoTitle %}
        {% set vars = {
          'image': entry.featuredImage[0],
          'lazyImage': true,
          'classes': 'post-intro__image--asset',
          'title': imageAlt,
        }%}
        {% include 'utils/images/home-feature-pic' with vars %}
      </div>
      {% if recipe %}
        <button class="post-intro__title--mobile-jump js-scroll-to btn gray small" data-scroll-target='recipe'>Jump to recipe</button>
      {% endif %}
      <div class="post-intro__pintip">
        {% spaceless %}
        <span class="post-intro__pintip--message"><span>
          {% include 'utils/icon' with {
            'icon': 'pinterest',
            'classes': 'post-intro__pintip--icon'
          } %}
        </span>Tap any image to pin it.</span>
        {% endspaceless %}
      </div>
    </div>
    <div class="post js-fix-share-trigger">
      {% include 'posts/_post-builder' %}

      {% if recipe %}
        {% include 'posts/_recipe-builder' %}
      {% endif %}
    </div>
  </div>
  
  {% include 'posts/_more-posts' %}

  <div class="comments__wrapper disqus">
    <div id="disqus_thread" class="comments"></div>
  </div>
  {% include 'posts/_fixed-share' %}
{% endblock %}

{# {% set recipeJSONLD = {
	"type": "Recipe",
	"author": entry.postAuthor|length ? entry.postAuthor ~ " at The Modern Proper" : "The Modern Proper",
  "datePublished": entry.postDate.iso8601(),
  "description": entry.postSummary,
  "image": photoArray[1:7],
  "recipeIngredient": ingredientsArray,
  "name": entry.postEntrySeo.seoTitle is defined ? entry.postEntrySeo.seoTitle : entry.title,
  "recipeInstructions": entry.recipeMethod|length ? entry.recipeMethod|striptags : "",
  "recipeYield": entry.recipeServings > 0 ? "Serves " ~ entry.recipeServings : "",
} %} #}

{# {% block postMeta %}
  {% if recipe is defined %}
    {{ recipeJSONLD | renderJSONLD }}
  {% endif %}
{% endblock %} #}

{% block footerJs %}
  {% include 'posts/scripts/_pinterest' %}
  {% include 'posts/scripts/_disqus' %}
  {% include 'posts/scripts/_facebook' %}
  {% include 'posts/scripts/_twitter' %}
{% endblock %}
